# Automated accuracy tracking for HockeyQuant
# - Per-game predictions: Stores official predictions 15 min before each game
# - Runs every 10 minutes during typical game hours to catch each game's window
# - Updates results after games finish (2 AM ET)

name: Accuracy Automation

on:
  schedule:
    # Run every 10 minutes during typical NHL game hours
    # Games typically start between 7 PM ET (midnight UTC) and 10:30 PM ET (3:30 AM UTC)
    # Earliest matinee games can start at 1 PM ET (6 PM UTC)
    # Running from 5 PM ET to 1 AM ET covers most games with some buffer
    # UTC times: 22:00 to 06:00
    - cron: '*/10 17-23 * * *'  # 5 PM - 11:59 PM UTC (12 PM - 7 PM ET)
    - cron: '*/10 0-6 * * *'    # 12 AM - 6 AM UTC (7 PM ET - 1 AM ET)
    # Update results at 2 AM ET (7 AM UTC) - after all games
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'store-predictions'
        type: choice
        options:
          - store-predictions
          - update-results

jobs:
  # Job 1: Store official predictions for games within 15-min window
  store-predictions:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 7 * * *' || github.event.inputs.action == 'store-predictions'
    steps:
      - name: Get today's date
        id: date
        run: echo "today=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Store predictions for games in window
        run: |
          DATE=${{ steps.date.outputs.today }}
          echo "Checking and storing predictions for $DATE at $(date -u)"

          # Call the endpoint - it handles per-game logic internally
          # Only stores predictions for games within 15-min window that aren't already stored
          RESPONSE=$(curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/store-predictions/$DATE")
          echo "Response: $RESPONSE"

          # Parse response
          STORED=$(echo "$RESPONSE" | jq -r '.stored // 0')
          SKIPPED=$(echo "$RESPONSE" | jq -r '.skipped_existing // 0')
          NOT_YET=$(echo "$RESPONSE" | jq -r '.not_yet_in_window // 0')

          echo ""
          echo "Summary:"
          echo "  - Newly stored: $STORED"
          echo "  - Already stored (skipped): $SKIPPED"
          echo "  - Not yet in window: $NOT_YET"

  # Job 2: Update results for completed games
  update-results:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 7 * * *' || github.event.inputs.action == 'update-results'
    steps:
      - name: Update all pending results
        run: |
          echo "Updating all pending results at $(date -u)"
          RESPONSE=$(curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/update-all-pending")
          echo "Response: $RESPONSE"

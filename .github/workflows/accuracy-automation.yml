# Automated accuracy tracking for HockeyQuant
# - Stores predictions 30 minutes before first game (dynamic timing)
# - Updates results after games finish (2 AM ET)

name: Accuracy Automation

on:
  schedule:
    # Check for games at 6 AM ET (11 AM UTC) - early enough for any game start
    - cron: '0 11 * * *'
    # Update results at 2 AM ET (7 AM UTC) - after all games
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check-and-store'
        type: choice
        options:
          - check-and-store
          - store-predictions-now
          - update-results

jobs:
  # Job 1: Check for games and store predictions 30 min before first game
  store-predictions:
    runs-on: ubuntu-latest
    timeout-minutes: 600  # 10 hours max (covers latest possible game starts)
    if: github.event.schedule == '0 11 * * *' || github.event.inputs.action == 'check-and-store' || github.event.inputs.action == 'store-predictions-now'
    steps:
      - name: Get today's date
        id: date
        run: echo "today=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Check for games and get first game time
        id: games
        run: |
          DATE=${{ steps.date.outputs.today }}
          echo "Checking games for $DATE..."

          # Query the API for first game time
          RESPONSE=$(curl -s "https://hockeyquant.onrender.com/api/accuracy/first-game-time/$DATE")
          echo "API Response: $RESPONSE"

          # Parse the response
          FIRST_GAME=$(echo "$RESPONSE" | jq -r '.first_game_utc // empty')

          if [ -z "$FIRST_GAME" ] || [ "$FIRST_GAME" == "null" ]; then
            echo "No games scheduled for $DATE"
            echo "has_games=false" >> $GITHUB_OUTPUT
          else
            echo "First game at: $FIRST_GAME"
            echo "has_games=true" >> $GITHUB_OUTPUT
            echo "first_game_utc=$FIRST_GAME" >> $GITHUB_OUTPUT
          fi

      - name: Store predictions repeatedly until 30 min before game
        if: steps.games.outputs.has_games == 'true'
        run: |
          DATE=${{ steps.date.outputs.today }}
          FIRST_GAME="${{ steps.games.outputs.first_game_utc }}"
          FORCE_NOW="${{ github.event.inputs.action == 'store-predictions-now' }}"

          # Parse the ISO timestamp to get cutoff time (30 min before first game)
          FIRST_GAME_EPOCH=$(date -d "$FIRST_GAME" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${FIRST_GAME%Z}" +%s 2>/dev/null || echo "0")

          if [ "$FIRST_GAME_EPOCH" == "0" ]; then
            echo "Warning: Could not parse game time, storing predictions once"
            curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/store-predictions/$DATE"
            exit 0
          fi

          # Cutoff = 30 minutes before first game
          CUTOFF_EPOCH=$((FIRST_GAME_EPOCH - 1800))

          echo "First game at epoch: $FIRST_GAME_EPOCH"
          echo "Cutoff (30 min before): $CUTOFF_EPOCH"

          # If force-now, just store once and exit
          if [ "$FORCE_NOW" == "true" ]; then
            echo "Force storing predictions now..."
            curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/store-predictions/$DATE"
            exit 0
          fi

          # Loop: store predictions every 30 minutes until cutoff
          ITERATION=1
          while true; do
            NOW_EPOCH=$(date +%s)

            if [ $NOW_EPOCH -ge $CUTOFF_EPOCH ]; then
              echo "Reached cutoff time, stopping updates"
              break
            fi

            echo ""
            echo "=== Iteration $ITERATION at $(date -u) ==="
            echo "Storing/updating predictions for $DATE..."

            RESPONSE=$(curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/store-predictions/$DATE")
            echo "Response: $RESPONSE"

            CACHED=$(echo "$RESPONSE" | jq -r '.cached // false')
            UPDATED_AT=$(echo "$RESPONSE" | jq -r '.updated_at // "unknown"')
            echo "Cache status: $CACHED, Updated at: $UPDATED_AT"

            # Calculate time until cutoff
            NOW_EPOCH=$(date +%s)
            TIME_TO_CUTOFF=$((CUTOFF_EPOCH - NOW_EPOCH))

            if [ $TIME_TO_CUTOFF -le 0 ]; then
              echo "Cutoff reached after storing, exiting"
              break
            fi

            # Sleep for 30 minutes (1800 seconds) or until cutoff, whichever is shorter
            SLEEP_TIME=1800
            if [ $TIME_TO_CUTOFF -lt $SLEEP_TIME ]; then
              SLEEP_TIME=$TIME_TO_CUTOFF
            fi

            echo "Sleeping for $SLEEP_TIME seconds (next update at $(date -u -d "+$SLEEP_TIME seconds" 2>/dev/null || echo "in $SLEEP_TIME seconds"))"
            sleep $SLEEP_TIME

            ITERATION=$((ITERATION + 1))
          done

          echo ""
          echo "=== Prediction updates complete ==="
          echo "Total iterations: $ITERATION"

      - name: No games today
        if: steps.games.outputs.has_games != 'true'
        run: echo "No games scheduled for today, skipping prediction storage"

  # Job 2: Update results for completed games
  update-results:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 7 * * *' || github.event.inputs.action == 'update-results'
    steps:
      - name: Update all pending results
        run: |
          echo "Updating all pending results at $(date -u)"
          RESPONSE=$(curl -s -X POST "https://hockeyquant.onrender.com/api/accuracy/update-all-pending")
          echo "Response: $RESPONSE"
